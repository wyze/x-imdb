<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-ajax/core-ajax.html">
<!--
Element to display information from IMDB.

##### Example

    <x-imdb imdbid="tt1285016"></x-imdb>

@element x-imdb
@blurb Element to display information from IMDB.
@status alpha
@author Neil Kistner
@homepage http://wyze.github.io/x-imdb
-->
<polymer-element name="x-imdb" attributes="imdbid layout">
  <template>
    <core-ajax auto handleAs="json" response="{{resp}}" url="http://omdbapi.com/" on-core-response="{{parseMovie}}"></core-ajax>
    <link rel="stylesheet" href="x-imdb.css">

    <template if="{{ layout == 'debug' }}">
      <section></section>
    </template>
  </template>
  <script>
    Polymer('x-imdb', {
      /**
       * The `imdbid` attribute is the IMDB ID of the movie to display.
       *
       * @attribute imdbid
       * @type string
       */
      imdbid: '',

      /**
       * The `layout` attribute defines how to render the response.
       *
       * @attribute layout
       * @type string
       */
      layout: 'debug',

      ready: function() {
        this.ajax = this.q('core-ajax');

        // validate our required property
        if ( !/^t{2}?\d{7}$/.test(this.imdbid) ) {
          throw 'Please provide a proper IMDB ID.';
        }

        this.ajax.params = { "i": this.imdbid.replace(/^([^tt])/, 'tt$1') };
      },

      attributeChanged: function( attr, old, value ) {
        if ( attr === 'imdbid' )
          this.ajax.params = { "i": this.imdbid.replace(/^([^tt])/, 'tt$1') };
      },

      /**
       * The `parseMovie` method will parse the response from OMDB API.
       *
       * @method parseMovie
       * @return {Object} Returns undefined.
       * @param {Object} e Event object for the core-ajax element.
       * @param {Object} request Object containing the response and XHR.
       */
      parseMovie: function( e, request ) {
        if ( this.layouts[this.layout] ) {
          this.layouts[this.layout].call(this, request.response);
        } else {
          this.layouts.debug.call(this, request.response);
        }
      },

      layouts: {
        debug: function( movie ) {
          var section = this.q('section');

          // clear the section
          while( section.firstChild ) {
            section.removeChild(section.firstChild);
          }

          for( var prop in movie ) {
            var container = this.c('div'),
                label     = this.c('label'),
                span      = this.c('span');

            label.innerHTML = prop;
            span.innerHTML = movie[prop];

            container.appendChild(label);
            container.appendChild(span);
            section.appendChild(container);
          }
        }
      },

      /**
       * The `q` method is a shortcut for document.querySelector.
       *
       * @method q
       * @return {Object} Returns DOMNode.
       * @param {String} selector A valid CSS3 selector.
       */
      q: function( selector ) {
        return this.shadowRoot.querySelector(selector);
      },

      /**
       * The `c` method is a shortcut to create a dom node.
       *
       * @method c
       * @return {Object} Returns DOMNode.
       * @param {String} element TagName of the element to create.
       */
      c: function( element ) {
        return document.createElement(element);
      }
    });
  </script>
</polymer-element>
